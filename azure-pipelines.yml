resources:
  repositories:
    - repository: security-guardrails
      type: git
      name: platform/security-guardrails

# ── Build stage ───────────────────────────────────────────────────────────────
stages:
  - stage: Build
    jobs:
      - job: BuildDockerImage
        steps:
          - task: Docker@2
            displayName: "Build Docker Image"
            inputs:
              command: build
              repository: myapp
              tags: $(Build.BuildId)

          # Tag the image so the security stage can find it
          - script: echo "##vso[task.setvariable variable=IMAGE_REF;isOutput=true]myapp:$(Build.BuildId)"
            name: setImageRef
            displayName: "Export image ref"

  # ── Security stage ────────────────────────────────────────────────────────
  - stage: Security
    dependsOn: Build
    variables:
      imageRef: $[ stageDependencies.Build.BuildDockerImage.outputs['setImageRef.IMAGE_REF'] ]
    jobs:
      - job: SecurityScans
        steps:
          - template: ci/azure-devops/security-orchestrator.yml@security-guardrails
            parameters:
              branch: $(Build.SourceBranchName)
              repoName: $(Build.Repository.Name)
              imageRef: $(imageRef)          # ← triggers Trivy image scan